<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OX Quiz (웹)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "맑은 고딕", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .app {
      background: #fff;
      max-width: 700px;
      width: 100%;
      margin: 16px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 20px;
      font-size: 22px;
      text-align: center;
    }
    .btn {
      display: inline-block;
      padding: 10px 16px;
      margin: 6px 4px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
    }
    .btn.secondary {
      background: #777;
    }
    .btn.small {
      font-size: 14px;
      padding: 6px 10px;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .center {
      text-align: center;
    }
    #question-text {
      font-size: 18px;
      margin: 30px 0;
      text-align: center;
      line-height: 1.5;
      min-height: 80px;
    }
    #status-text {
      font-size: 14px;
      text-align: center;
      min-height: 24px;
    }
    .ox-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    .ox-btn {
      width: 90px;
      height: 90px;
      font-size: 30px;
      border-radius: 50%;
    }
    /* 오답 팝업 오버레이 */
    #wrong-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;           /* 처음에는 무조건 안 보이게 */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #wrong-popup {
      background: #fff;
      padding: 18px 24px;
      border-radius: 10px;
      max-width: 260px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    #wrong-popup-message {
      font-size: 15px;
      margin-bottom: 16px;
    }
    @media (max-width: 480px) {
      .ox-btn {
        width: 80px;
        height: 80px;
        font-size: 28px;
      }
      .app {
        margin: 8px;
        padding: 16px;
      }
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- 메인 메뉴 -->
  <div id="main-menu">
    <h1>OX Quiz</h1>
    <div class="center">
      <button class="btn" id="btn-start">문제 풀기</button><br>
      <button class="btn" id="btn-review">오답 풀기 (최근 7일)</button><br>
      <button class="btn secondary small" id="btn-reset">기록 전체 초기화</button>
    </div>
  </div>

  <!-- 문제 풀이 화면 -->
  <div id="quiz-screen" class="hidden">
    <div id="question-text"></div>
    <div class="ox-buttons">
      <button class="btn ox-btn" id="btn-o">O</button>
      <button class="btn ox-btn" id="btn-x">X</button>
    </div>
    <div id="status-text"></div>
    <div class="center" style="margin-top: 10px;">
      <button class="btn secondary small" id="btn-back">메인 화면으로</button>
    </div>
  </div>
</div>

<!-- 오답 팝업 -->
<div id="wrong-overlay">
  <div id="wrong-popup">
    <div id="wrong-popup-message">틀렸어 짜식아~</div>
    <button class="btn small" id="wrong-popup-close">다시 풀기</button>
  </div>
</div>

<script>
  // ================== 문제 데이터 (questions.json에서 로드) ==================
  let questions = [];
  let questionsLoaded = false;

  async function loadQuestions() {
    try {
      const res = await fetch("questions.json");
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const data = await res.json();
      if (!Array.isArray(data)) {
        throw new Error("JSON이 배열 형식이 아닙니다.");
      }
      // 파이썬 버전과 같은 형식: {question, answer, subject?}
      questions = data.filter(item => {
        return typeof item.question === "string" &&
               typeof item.answer === "string" &&
               (item.answer.toUpperCase() === "O" || item.answer.toUpperCase() === "X");
      });
      questionsLoaded = true;
    } catch (e) {
      alert("문제 파일(questions.json)을 불러오는 중 오류가 발생했습니다.\n" + e);
      questions = [];
      questionsLoaded = false;
    }
  }

  // ================== 공통 유틸 ==================
  function shuffle(array) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function formatDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  const STORAGE_PREFIX = "oxquiz_results_";

  function resultKeyFor(dateStr) {
    return STORAGE_PREFIX + dateStr;
  }

  function loadResultData(dateStr) {
    const key = resultKeyFor(dateStr);
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return { correct: [], wrong: [] };
      const obj = JSON.parse(raw);
      if (!obj.correct) obj.correct = [];
      if (!obj.wrong) obj.wrong = [];
      return obj;
    } catch (e) {
      return { correct: [], wrong: [] };
    }
  }

  function saveResultData(dateStr, data) {
    const key = resultKeyFor(dateStr);
    localStorage.setItem(key, JSON.stringify(data));
  }

  function saveResultRecord(questionObj, userAnswer, correctAnswer, isCorrect) {
    const today = getTodayStr();
    const data = loadResultData(today);
    const record = {
      question: questionObj.question || "",
      correct_answer: correctAnswer,
      user_answer: userAnswer,
      is_correct: isCorrect,
      time: new Date().toISOString().replace("T", " ").slice(0, 19),
      subject: questionObj.subject || null
    };
    if (isCorrect) {
      data.correct.push(record);
    } else {
      data.wrong.push(record);
    }
    saveResultData(today, data);
  }

  function collectRecentWrongQuestions(allQuestions) {
    const bankMap = {};
    allQuestions.forEach(q => {
      bankMap[q.question] = q;
    });

    const today = new Date();
    const uniqueWrong = {};

    for (let i = 0; i < 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const ds = formatDate(d);
      const data = loadResultData(ds);
      (data.wrong || []).forEach(item => {
        const qText = item.question;
        if (!qText) return;
        if (bankMap[qText] && !uniqueWrong[qText]) {
          uniqueWrong[qText] = bankMap[qText];
        }
      });
    }

    return Object.values(uniqueWrong);
  }

  // ================== 상태 / DOM 참조 ==================
  const mainMenu = document.getElementById("main-menu");
  const quizScreen = document.getElementById("quiz-screen");
  const questionText = document.getElementById("question-text");
  const statusText = document.getElementById("status-text");

  const btnStart = document.getElementById("btn-start");
  const btnReview = document.getElementById("btn-review");
  const btnReset = document.getElementById("btn-reset");
  const btnO = document.getElementById("btn-o");
  const btnX = document.getElementById("btn-x");
  const btnBack = document.getElementById("btn-back");

  const wrongOverlay = document.getElementById("wrong-overlay");
  const wrongPopupMessage = document.getElementById("wrong-popup-message");
  const wrongPopupClose = document.getElementById("wrong-popup-close");

  let currentList = [];
  let currentIndex = 0;
  let mode = null; // "normal" or "review"

  // ================== 화면 전환 ==================
  function showMainMenu() {
    quizScreen.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    statusText.textContent = "";
  }

  function showQuizScreen() {
    mainMenu.classList.add("hidden");
    quizScreen.classList.remove("hidden");
  }

  // ================== 문제 표시 ==================
  function showCurrentQuestion() {
    if (!currentList.length) {
      questionText.textContent = "문제가 없습니다.";
      return;
    }
    if (currentIndex < 0 || currentIndex >= currentList.length) {
      questionText.textContent = "더 이상 풀이할 문제가 없습니다.";
      return;
    }
    const q = currentList[currentIndex];
    questionText.textContent = q.question || "";
  }

  function gotoNextQuestion() {
    currentIndex += 1;
    if (currentIndex >= currentList.length) {
      alert("더 이상 풀이할 문제가 없습니다.\n메인 화면으로 돌아갑니다.");
      showMainMenu();
    } else {
      statusText.textContent = "";
      showCurrentQuestion();
    }
  }

  // ================== 모드 시작 ==================
  function startNormalMode() {
    if (!questionsLoaded) {
      alert("문제를 아직 불러오는 중이거나, 파일을 읽지 못했습니다.\n잠시 후 다시 시도해 줘.");
      return;
    }
    if (!questions.length) {
      alert("문제가 없습니다.\nquestions.json 파일을 확인해 줘.");
      return;
    }
    mode = "normal";
    currentList = shuffle(questions);
    currentIndex = 0;
    statusText.textContent = "";
    showQuizScreen();
    showCurrentQuestion();
  }

  function startReviewMode() {
    if (!questionsLoaded) {
      alert("문제를 아직 불러오는 중이거나, 파일을 읽지 못했습니다.\n잠시 후 다시 시도해 줘.");
      return;
    }
    if (!questions.length) {
      alert("문제가 없습니다.\nquestions.json 파일을 확인해 줘.");
      return;
    }
    const wrongList = collectRecentWrongQuestions(questions);
    if (!wrongList.length) {
      alert("최근 7일 동안 다시 풀 오답이 없습니다.");
      return;
    }
    mode = "review";
    currentList = shuffle(wrongList);
    currentIndex = 0;
    statusText.textContent = "최근 7일 오답만 다시 풉니다.";
    showQuizScreen();
    showCurrentQuestion();
  }

  // ================== 오답 팝업 ==================
  function showWrongPopup(msg) {
    wrongPopupMessage.textContent = msg;
    wrongOverlay.style.display = "flex";   // 팝업 표시
  }

  function hideWrongPopup() {
    wrongOverlay.style.display = "none";   // 팝업 숨김
  }

  // 오버레이 바깥 클릭 시 닫기
  wrongOverlay.addEventListener("click", (e) => {
    if (e.target === wrongOverlay) hideWrongPopup();
  });

  wrongPopupClose.addEventListener("click", hideWrongPopup);

  // ================== 답변 처리 ==================
  function handleAnswer(userAnswer) {
    if (!currentList.length) return;
    const q = currentList[currentIndex];
    const correctAnswer = (q.answer || "").toUpperCase();
    const isCorrect = userAnswer === correctAnswer;

    // 결과 저장 (파이썬 버전과 같은 구조)
    saveResultRecord(q, userAnswer, correctAnswer, isCorrect);

    if (isCorrect) {
      statusText.textContent = "정답입니다. 잘하셨습니다.";
      setTimeout(() => {
        gotoNextQuestion();
      }, 500);
    } else {
      statusText.textContent = "오답입니다. 다시 한 번 골라 보세요.";
      const msgList = [
        "틀렸어 짜식아~",
        "어허",
        "슷",
        "죽는다 진짜",
        "이렇게해선 내가 도움을 줄 수가 없어.",
        "다시",
        "다시",
        "다시"
      ];
      const msg = msgList[Math.floor(Math.random() * msgList.length)];
      showWrongPopup(msg);
      // 같은 문제 다시 풀기 (currentIndex 그대로)
    }
  }

  // ================== 기록 초기화 ==================
  function resetAllResults() {
    if (!confirm("정말로 모든 기록을 삭제할까?\n(최근 7일 오답도 전부 사라진다.)")) {
      return;
    }
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith(STORAGE_PREFIX)) {
        keysToRemove.push(key);
      }
    }
    keysToRemove.forEach(k => localStorage.removeItem(k));
    alert("기록을 모두 삭제했다.");
  }

  // ================== 이벤트 바인딩 ==================
  btnStart.addEventListener("click", startNormalMode);
  btnReview.addEventListener("click", startReviewMode);
  btnBack.addEventListener("click", showMainMenu);
  btnO.addEventListener("click", () => handleAnswer("O"));
  btnX.addEventListener("click", () => handleAnswer("X"));
  btnReset.addEventListener("click", resetAllResults);

  // 페이지 로드 시 문제 파일 먼저 로딩
  window.addEventListener("load", () => {
    loadQuestions();
  });
</script>
</body>
</html>
